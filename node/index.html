<html>
<head><title>InMobi Buzz</title></head>

<script language="javascript" type="text/javascript" src="/static/jquery.js"></script>
<script language="javascript" type="text/javascript" src="/static/jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="/static/jquery.flot.pie.js"></script>

<style type="text/css">
div.graph
		{
			width: 200px;
			height: 150px;
			border: 1px dashed gainsboro;
	    }	


</style>
<body>
<h3>InMobi Buzz</h3>

<div id='channelContainer'>
</div>
<br>
<div id="tickDisplayArea">
<div id="tickList">
</div>
</div>

<script src="/socket.io/socket.io.js"></script>
    <script>
    // global var to store pie-chart data
    channelCounts = new Array();
    // Tick store
    var tickStore = window.localStorage;
    tickStore.clear();

    var getChannelTicks = function (channel, label) {
        console.log(' GETTTING TICKS FOR ' + channel + label);
        var ticks = new Array();
        var ids = JSON.parse(tickStore[channel + label + '_ids']);

        for ( i in ids ) {
            var tid = ids[i];
            console.log('Getting tick: ' + tid);
            tickstr = tickStore[channel + '_' + tid];
            console.log('GOT TICK' + tickstr);

            ticks.push(tickstr);
        }
        return ticks;
    };

    var displayTicks = function (channel, label) {
        var ticks = getChannelTicks(channel, label);

        $('#tickList').empty();

        $('#tickList').append('<div class="chartTitle">Ticks for ' + channel + ':' + label + '</div>');
        $('#tickList').append('<ol id="tickLi"></ol>');
        for (t in ticks) {
            var tickstr = ticks[t];
            var tick = JSON.parse(tickstr);
            console.log(t.link);
            $('#tickLi').append('<li><a href="' + tick.link + '">' + tick.title + '</a></li>');
        }
    };

    
    var plotClickCb = function (event, pos, obj) {
        if (!obj) {
            return;
        }

        var selDiv = event.currentTarget;
        var channel = selDiv.getAttribute('id').replace("channel_", "");

        var lbl = obj.series.label;
        displayTicks(channel, lbl);
    };


    var plotHoverCb = function (event, pos, obj) {
    };

    var drawChart = function (channel) {
        // Set chart in the div for this channel
        var channelDiv = $('#channel_' + channel);

        if (channelDiv.length === 0) {
            $('#channelContainer').append('<div class="chartTitle">' + channel 
            + '<div id="channel_' + channel + '" class="graph"></div> </div>');
            channelDiv = $('#channel_' + channel); 
        }

        // clear previous plot
        channelDiv.empty();

        // Data for this plot
        var counts = channelCounts[channel];
        console.log('COUNTS SO FAR: '  + JSON.stringify(counts));
        var plotData = new Array();
        for (key in counts) {
            plotData.push( { label: key , data: counts[key]});
        }

        $.plot(channelDiv, plotData, 
        /* Plot options */
        {
                series: {
                    pie: { 
                      show: true
                    }
                },
                legend: {
                   show: false
                },

                grid: {
                  hoverable: true,
                  clickable: true
                }
        });

        channelDiv.bind('plothover', plotHoverCb);
        channelDiv.bind('plotclick', plotClickCb);
    };

    var socket = io.connect('http://localhost:8080/');

    socket.on('tick', function (tick) {
        console.log('Got new tick' + JSON.stringify(tick));
        var channel = tick.channel;
        var label = tick.label;

        var counts = channelCounts[channel];
        // Update counts
        
        if (!counts) {
          counts = new Object();
          counts[label] = 1;
          channelCounts[channel] = counts;
        }

        var precount = counts[label];
        if (precount) {
            counts[label] = precount + 1;
        } else {
            counts[label] = 1;
        }


        // Store the tick in local storage
        tickStore[channel + "_" + tick.id] = JSON.stringify({
            id: tick.id, 
            title: tick.title,
            link: tick.link
        });

        var channelIds = tickStore.getItem(channel + label + '_ids');
        if (!channelIds) {
            channelIds = '[]';
        }
        // Store IDs for easy retrieval later during displaying ticks of a channel
        var ids = JSON.parse(channelIds);
        ids.push(tick.id);
        tickStore[channel + label +  '_ids'] = JSON.stringify(ids);
        // Refresh chart
        drawChart(channel);
    });

    console.log("APP SETUP");
    </script>
</body>
</html>
